```
Ongakken Corporation OU                                                OC Std 2.5
Kalaranna tn 8/2-30, 10415                                       (Revision of 2.4)
Tallinn, Harju maakond
Estonia
Registry code: 17168301
```

```
                                         @@@@@@@@@@@@@@@@@@
                                  @@@@@@@                  @@@@@@@
                              @@@@@                              @@@@@
                           @@@         @@@@@@@@@@@@@@   @@@@@         @@@
                        @@@      @@@@@@            @@   @@@@@@@@@@@     @@@@
                      @@@     @@@@@      @@@@@@@   @@   @@@@@      @@@     @@@
                    @@     @@@@@@@@@@@@@@       @@@@@          @@@   @@@@     @@
                   @@   @@@@@@@@@@@@@@@@   @@@   @@@@         @@@@@  @@@@@@@   @@@
                                           @@@@  @@   @@@@@@         @    @@@    @@@
                    @@@@@@@@@@   @@@@@@@@        @@     @@@@@@    @@@@@@@@@@@@@    @@
                           @@@   @@@@@@@@@@    @@@   @@@@   @@@@@@@@@@@    @@@@@@   @@@
                            @@   @@@@@@@@@@@@@@@@@@@@@@        @@  @@        @@@@@    @@
                            @@                          @@@@@  @@ @@   @@@@   @@@@@    @@
                             @@                          @@@   @@  @@  @@@    @   @@    @@
          @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@       @@    @       @@@    @@@   @@
         @                   @          @@@@        @ @@@@@@@@       @@@  @@@@@@@@@@@@@  @@@
        @@   @@@@  @@@@@@@   @@       @@         @@                  @@@  @@@@      @@@   @@
       @@   @@@@@   @@@@@@   @@     @@@    @@@@@                     @@@  @@@         @@   @@
      @@   @@@@@@   @@  @@   @@    @@    @@@                         @@@  @@@  @@@@   @@@   @@
      @@   @@  @@   @@@@@@   @@@@@@    @@@                           @@@  @@@    @    @@@   @@
     @@   @@   @@   @@@@       @@@@   @@                         @@@@@@@  @@@@      @@@@@@   @@
     @@   @@   @@   @@@   @@@   @@   @@                        @           @@@@@  @@@   @@   @@
     @@   @    @@   @@@   @@@   @   @@                        @@          @  @@@   @@   @@@  @@
    @@   @@    @@   @@@@       @@  @@@                        @@   @@@@@      @@  @@@@@@@@@   @@
    @@   @@    @@   @@@@@@   @@@   @@                          @@   @@       @@@  @@@@@@@@@   @@
    @@   @@   @@@  @@@@@    @@@@  @@@                          @@   @@   @@@@@@@              @@
    @@   @@ @@        @@      @@  @@                           @@@  @@@@@      @@@@@@@@@@@@@  @@
    @@   @@@@@  @@@@   @@     @@  @@                            @@  @@@@   @@   @@@@@@@@@@@@  @@
    @@   @@@@@  @@@@   @@@@@@@@@  @@                            @@  @@@   @@@@                @@
    @@   @@  @@       @@    @@@@  @@                            @@  @@@@        @@@@@@@@@@@@  @@
    @@   @@   @@@@@@@@        @@  @@@                          @@@  @@@@@     @@@@      @@@   @@
    @@   @@       @@@  @@@@@  @@   @@                          @@   @@    @@@@@@@@@@     @@   @@
    @@   @@        @@   @@@   @@   @@                          @@   @@       @@@@    @@@@@@   @@
    @@   @@        @@@       @@@@   @@                        @@   @@@@@@@@@@@@        @@@@   @
     @@   @@  @@@@@@@@@@@  @@@@@@   @@                        @                  @@@@   @@@  @@
     @@   @@@@       @@@@  @@@@@@@   @@                        @                 @@@@   @@   @@
     @@   @@@   @@@   @@@  @@@@@@@@   @@@                        @@@@@@@@@@@@@@       @@@@   @
      @@   @@  @@@@@          @@ @@@   @@@                                    @@@@@@@@@@@   @@
      @@   @@@        @@@@@@  @@   @@    @@@@                                @@@@@@@@@@@    @
       @@   @@@@    @@@ @@@@  @@    @@@     @@@@@@              @@@@@@@@@@@@@@@@@@@@@@@@   @@
        @@   @@@@@@      @@@  @@     @@@@          @@          @                          @@
        @@@   @@         @@@  @@@@@@@@@@@@@@@      @@@@@@      @@  @@@@@@@@@@@@@@@@@@@@@@@
         @@    @@        @@@  @@@@     @@@@@@@@@@         @   @@@  @@@@
          @@    @@       @@@  @@    @    @@@@@@@@  @@@@   @@@@@@    @@@
           @@@   @@@@@@@@@@@  @@  @@@@@            @@@@   @@@@        @@      @@@@@
             @@               @@    @@   @@@@@@@@@@@@@@   @@@   @@@@   @   @@      @@
              @@              @@@@      @@@@@@@@     @@   @@@@   @@    @  @@    @    @
                 @@@@@@@@@@@@     @@@@@@   @@@@@@@ @@@@   @@@@@      @@   @@  @@@@@  @@
                           @@     @@@@@@@@@@      @@@      @@@@@@@@@@    @@@@   @    @
                        @@@@@@@@@@@@@@@@@@    @    @    @    @@        @@@@        @@
                       @                    @@@@@  @  @@@@@  @@      @@@@    @@@@@@
                       @@    @@@@@@@@@@@@@@   @    @         @@  @@@@      @@@
                         @@@      @@@@@@@@@@      @@@      @@@@@@@      @@@
                           @@@@@       @@@@@@@@@@@@@@@@@@@@@@       @@@@
                               @@@@@                            @@@@@
                                    @@@@@@@              @@@@@@@
                                           @@@@@@@@@@@@@@
```

# Global Development Standards

Software Development -- Build Systems, Code Style, and Tooling

## 1. Scope

1 This standard specifies requirements for software development across all repositories. Project-local standards may override specific provisions.
2 This standard covers version control, code style, build systems, and libdangling usage.
3 This standard extends and overrides ISO/IEC 9899:1999 (C99) and IEEE Std 1003.1-2017 (POSIX.1-2017) where applicable.

## 2. Conformance

1 In this standard, "shall" is to be interpreted as a requirement on an implementation or on a program; conversely, "shall not" is to be interpreted as a prohibition.
2 If a "shall" or "shall not" requirement is violated, the behavior is undefined unless otherwise specified.
3 "Should" indicates a recommended practice; deviation requires justification. "May" indicates optional behavior.
4 "Undefined behavior" results from use of an invalid program construct. "Unspecified behavior" results from use of a valid construct where two or more possibilities exist. "Implementation-defined behavior" results from use of a valid construct where the choice shall be documented.

## 3. Terms and Definitions

| Term | Definition |
|------|-----------|
| Coccinelle | Semantic patch tool for C (`spatch`) |
| Vale | Prose linting tool for style guides |
| sd | Text replacement tool; used in place of `sed` |
| ctags | Source code indexing for symbol navigation |
| ast-grep | Structural code search matching AST patterns |
| guard clause | Conditional at function start, returns early on invalid input |
| Allman braces | Opening brace on its own line, aligned with control statement |
| snake_case | Lowercase words separated by underscores |

Priority levels (descending severity): **BLUE** (security-critical, maximum) > **ULTRAVIOLET** (high-severity security) > **PRIORITY** (elevated importance) > **unmarked** (default, equal among themselves).

---

## 4. libdangling

libdangling is the canonical utility library for all C projects. It shall be used for all utilities it provides; redefinition of its facilities is prohibited. Installation shall be verified via `pkg-config --cflags --libs dangling`. The source resides at `~/git/libdangling`.

### 4.1 Macros (`core/macros.h`, `core/bits.h`)

Branch hints: `LDG_LIKELY()`, `LDG_UNLIKELY()` | Sizes: `LDG_KIB/MIB/GIB` | Time: `LDG_MS_PER_SEC`, `LDG_NS_PER_MS/SEC`, `LDG_SECS_PER_MIN/HOUR` | Bases: `LDG_BASE_DECIMAL/HEX` | Byte/bit: `LDG_BYTE_BITS/MASK/SHIFT_*`, `LDG_NIBBLE_BITS/MASK`, `LDG_WORD_BYTES`, `LDG_IS_POW2()` | String: `LDG_STR_TERM(_SIZE)` | Init: `LDG_STRUCT_ZERO_INIT`, `LDG_ARR_ZERO_INIT` | Alignment: `LDG_AMD64_CACHE_LINE_WIDTH`, `LDG_ALIGNED`, `LDG_ALIGNED_UP/DOWN()`

### 4.2 Error Codes (`core/err.h`)

Error codes 0 through 690 are reserved for libdangling. Project-specific codes shall use the range 700 through 990. Generic conditions shall use libdangling error codes.

| Range | Category |
|-------|----------|
| 0 | `LDG_ERR_AOK` |
| 1-99 | Generic: `_FUNC_ARG_NULL/_INVALID`, `_ALLOC_NULL`, `_NOT_INIT`, `_FULL`, `_OVERFLOW`, `_EMPTY`, `_BUSY`, `_INVALID`, `_TIMEOUT`, `_NOT_FOUND`, `_EXISTS`, `_DENIED`, `_UNSUPPORTED`, `_CANCELLED`, `_INTERRUPTED`, `_RANGE`, `_BOUNDS`, `_WOULD_BLOCK`, `_AGAIN`, `_CLOSED`, `_EOF` |
| 100-199 | Memory: `_MEM_BAD`, `_STR_TRUNC`, `_MEMMOVE_ALLOCD`, `_SENTINEL`, `_POOL_FULL/_INVALID`, `_DOUBLE_FREE`, `_ALIGNMENT`, `_CORRUPTION` |
| 200-299 | I/O: `_IO_NOT_FOUND`, `_READ/_WRITE/_FORMAT/_OPEN/_CLOSE/_SEEK/_FLUSH/_PERMISSION/_IS_DIR/_NOT_DIR` |
| 300-399 | Time: `_TIME_CORE_MIGRATED`, `_NOT_CALIBRATED` |
| 400-499 | Network: `_NET_INIT/_PERFORM/_TIMEOUT/_CONN/_DISCONNECTED/_REFUSED/_UNREACHABLE/_DNS/_TLS/_PROTOCOL/_RESET/_SEND/_RECV` |
| 500-599 | String: `_STR_TRUNC/_OVERLAP/_INVALID/_EMPTY/_FORMAT` |
| 600-649 | Audio: `LDG_ERR_AUDIO_*` |
| 650-690 | Protocol: `LDG_ERR_PROTO_EMIRU_*`, `LDG_ERR_PROTO_EMIEMI_*` |

Logging: `LDG_ERRLOG_ERR()`, `LDG_ERRLOG_WARN()`, `LDG_ERRLOG_INFO()`

### 4.3 Types (`core/types.h`)

`ldg_byte_t`, `ldg_word_t`, `ldg_dword_t`, `ldg_qword_t` (aliases: `byte_t`, `word_t`, `dword_t`, `qword_t`)

### 4.4 Memory (`mem/`)

All runtime allocation shall use pools (§7.4-5). Two pool modes: fixed-size (`item_size` > 0) for uniform objects with individual dealloc; variable-size (`item_size` == 0) as bump allocator for heterogeneous allocations with bulk-only dealloc via `ldg_mem_pool_reset()`.

`mem.h`: `ldg_mem_init/shutdown()`, `ldg_mem_alloc(size, &out)/realloc(ptr, size, &out)/dealloc(ptr)`, `ldg_mem_lock/locked_is()`, `ldg_mem_stats_get/leaks_dump/valid_is/size_get()`
`alloc.h`: `ldg_mem_pool_create(item_size, capacity, &out)/destroy/alloc(pool, size, &out)/dealloc/reset()`, `ldg_mem_pool_remaining_get/used_get/capacity_get/var_is()`
`secure.h`: `ldg_mem_secure_zero/copy/cmp/cmov/neq()`

### 4.5 String (`str/str.h`)

`ldg_strrbrcpy()`, `ldg_str_to_dec()`, `ldg_hex_str_is()`, `ldg_hex_to_bytes/dword()`, `ldg_byte_to_hex()`, `ldg_dword_to_hex()`, `ldg_char_*_is()` predicates

### 4.6 Time (`time/`)

`time.h`: `ldg_time_init/tick/get/monotonic_get/epoch_ms_get/epoch_ns_get/dt_get/dt_smoothed_get/fps_get/frame_cunt_get()`
`perf.h`: High-resolution performance timing

### 4.7 Threading (`thread/`)

`sync.h`: `ldg_mut_t` (`init/lock/unlock/trylock/destroy`); `ldg_cond_t` (`init/wait/timedwait/signal/broadcast/destroy`); `ldg_sem_t` (`init/open/wait/trywait/post/destroy`)
`spsc.h`: `ldg_spsc_queue_t`, `ldg_spsc_init/push/pop/peek/cunt/empty/full/shutdown()`
`pool.h`: `ldg_thread_pool_t`, `ldg_thread_pool_init/start/stop/shutdown/worker_cunt_get()`

### 4.8 Math (`math/linalg.h`)

`ldg_vec3_*()`, `ldg_mat3_*()` (add, sub, scale, dot, cross, mul, inv, det, trace, transpose)

### 4.9 Network (`net/curl.h`)

`ldg_curl_multi_ctx_t`, `ldg_curl_multi_ctx_create/req_add/perform/progress_get/ctx_destroy()`, `ldg_curl_resp_t`

### 4.10 Parsing (`parse/parse.h`)

`ldg_tok_t`, `ldg_tok_arr_t`, `ldg_parse_tokenize()`, `ldg_parse_streq()`

### 4.11 x86-64 (`arch/x86_64/`)

`fence.h`: `LDG_MFENCE/SFENCE/LFENCE/BARRIER/PAUSE`, `LDG_SMP_MB/WMB/RMB/SIG_FENCE()`
`atomic.h`: `LDG_READ_ONCE/WRITE_ONCE()`, `_AGGREGATE()` variants, `LDG_LOAD_ACQUIRE/STORE_RELEASE()`, `LDG_FETCH_ADD/SUB()`, `LDG_ADD_FETCH/SUB_FETCH()`, `LDG_CAS/CAS_WEAK()`
`prefetch.h`: `LDG_PREFETCH_R/W/NTA()`
`tsc.h`: `ldg_tsc_ctx_t`, `ldg_rdtsc/rdtscp()`, `ldg_tsc_calibrate/sample/serialized_sample/serialize/delta/to_sec()`
`cpuid.h`: `ldg_cpuid()`, `ldg_cpuid_features_t`, `ldg_cpuid_features_get/vendor_get/brand_get()`, `ldg_cpu_core_id_get/relax()`
`syscall.h`: `ldg_syscall0()` through `ldg_syscall4()`, `LDG_SYS_*` constants

### 4.12 Protocol (`proto/`)

`emiru.h`: `ldg_emiru_hdr_t`, `ldg_emiru_decoded_t`, `ldg_emiru_hdr_validate()`, `ldg_emiru_decode()`, `ldg_emiru_encode()`, `ldg_emiru_encoded_size_get()`
`emiemi.h`: `ldg_emiemi_io_ctx_t`, `ldg_emiemi_hdr_recv()`, `ldg_emiemi_payload_recv()`, `ldg_emiemi_recv()`, `ldg_emiemi_send()`, `ldg_emiemi_encode()`, `ldg_emiemi_decode()`, `ldg_emiemi_fnv1a()`, `ldg_emiemi_encoded_size_get()`

---

## 5. Version Control

### 5.1 Global Hooks

Location: `~/.config/git/hooks/` via `git config --global core.hooksPath`.

| Hook | Function |
|------|----------|
| `pre-commit` | Branch validation, binary blocking, formatting, static analysis |
| `prepare-commit-msg` | Auto-populate `type(scope):` from branch name |
| `commit-msg` | Conventional commit validation, scope matching |
| `pre-push` | Label warnings, WIP blocking, secrets scan, sanitizer tests |
| `pre-rebase` | Warning on pushed branches, blocking main/staging |
| `post-commit` | Qualified signature generation via `qsig` (§13) |
| `post-checkout` | compile_commands.json regeneration, ccache stats, stale branch warnings |

### 5.2 Scripts

Scripts are located at `~/.config/git/bin/` (on PATH). The `git bump` command shall produce the next semantic version. The `git bump --apply` command shall execute a git flow release. The `git release-notes` command shall generate a changelog via git-cliff.

### 5.3 Coccinelle

Coccinelle semantic patches are located at `~/.config/git/cocci/`. The tool shall be invoked as `run-all.sh /path/to/src` for reporting, or `run-all.sh /path/to/src --fix` for applying patches.

### 5.4 Branch Naming

Pattern: `type/name`. Types: `feat/ fix/ hot/ rel/ misc/ docs/ refactor/ test/ chore/ perf/ ci/ build/ revert/`. Non-conforming names result in undefined behavior.

### 5.5 Commit Messages

Pattern: `type(scope): description`. Length shall be 75-100 characters. Imperative mood; the description shall not end with a period. Only the description shall be provided; `type(scope):` is auto-populated by hook.

### 5.6 Commit Atomicity

One subsystem per commit (directory path + base filename). Scope shall match subsystem. `.h`/`.c` with same base name shall be committed together. `CMakeLists.txt` constitutes its own subsystem.

### 5.7 Test State Tracking

A minimum of 50% coverage shall be achieved before committing. Commands: `git test-state save/check`. Targets: `make tests` (build only), `make tests-run` (build + QEMU run + coverage + test-state save).

The pre-commit hook shall check the `.test-state` hash. If the hash is invalid, the hook shall run `make tests-run`, verify that 50% coverage is achieved, and save the resulting state. The hook shall block the commit on failure.

The `std_invalidate_test_state(main_target)` function shall handle recompilation invalidation. Coverage shall be enabled via `std.cmake` with `STD_DEBUG=ON`. The `.test-state` file shall be globally gitignored. Reports shall be generated in `build/coverage_html/`.

### 5.8 Git Invocation

`git -C <path>` shall not be used; run from repo root.

### 5.9 Git Flow

`git flow feature start/finish name` (feat/name, merges to staging). `git flow release start/finish 1.2.0` (rel/1.2.0, merges and tags).

### 5.10 QEMU Test Execution

All tests shall run inside persistent QEMU/KVM VMs (libvirt). Host-native execution shall not be used. Rationale: DKMS modules may panic host; single infrastructure for all tests.

#### 5.10.1 VM Architecture

Persistent VMs via `virsh`/`virt-install` (`qemu:///system`), provisioned from cloud images via `cloud-init`. Script: `~/git/dangstd/cmake/qemu/create-vm.sh dev|deploy`. Naming: `qemu-test-{variant}-{arch}`.

| Variant | Base | Purpose |
|---------|------|---------|
| `dev` | Arch Linux | Matches host kernel/glibc/toolchain; zero delta |
| `deploy` | Debian 12 | Older glibc (2.36) compatibility; static binaries only |

`dev` runs host kernel (`linux-zen`), version-locked via `IgnorePkg` on both host and VM.

VM config: 12 vCPUs, 4096 MiB RAM, 20 GiB qcow2, libvirt NAT, SSH via RSA 8192 key (`~/.ssh/id_qemu_test`), sshd MaxStartups 50:30:100, MaxSessions 50.

#### 5.10.2 Shared Libraries

Custom libs exposed via virtio-9p read-only shares:

| 9p Tag | Host -> VM Mount | Mode |
|--------|-----------------|------|
| `hostlib` | `/usr/local/lib` -> `/usr/local/lib` | ro |
| `hostinclude` | `/usr/local/include` -> `/usr/local/include` | ro |

Persisted in VM `/etc/fstab`. VM has `/usr/local/lib` in `ld.so.conf`, `/usr/local/lib/pkgconfig` in `PKG_CONFIG_PATH`. Distribution packages installed directly on VM.

#### 5.10.3 CMake Integration

```cmake
list(APPEND CMAKE_MODULE_PATH "$ENV{HOME}/.config/cmake")
include(std)
```

`std.cmake` shall enforce C99 (`CMAKE_C_STANDARD 99`, `CMAKE_C_EXTENSIONS OFF`), POSIX.1-2008, and the flags `-pedantic -Werror=pedantic`. Debug mode shall be enabled via `-DSTD_DEBUG=ON` (`-g -O0` + coverage). External dependencies shall use `SYSTEM` includes.

Test registration:
```cmake
qemu_add_test(NAME core_tests COMMAND test_core ARCH x86_64)
qemu_add_test(NAME core_deploy COMMAND test_core ARCH x86_64 VARIANT deploy)
qemu_add_cross_test(NAME core COMMAND test_core ARCHS x86_64 aarch64 riscv64)
qemu_add_test(NAME driver_test COMMAND test_driver ARCH x86_64 DKMS KERNEL_MODULE mydriver)
qemu_add_run_target()
```

`qemu_add_test()` parameters: NAME (required), COMMAND (required), ARCH (x86_64), VARIANT (dev), TIMEOUT (120), DKMS (off), KERNEL_MODULE.

The `make run-<name>` target shall execute a single test. The `make tests-run` target shall execute the full suite (`-j 12`) and shall invoke `lcov`, `genhtml`, and test-state save.

#### 5.10.4 Execution Flow

1. CTest shall invoke `qemu-runner.sh` per binary (`-j 12`).
2. The runner shall resolve the VM IP via `virsh domifaddr` and verify the VM is running.
3. The test binary shall be copied to the VM via `scp` (`/tmp/qemu-test-$$/test_binary`).
4. The binary shall be executed over `ssh` with `GCOV_PREFIX` and `GCOV_PREFIX_STRIP` set.
5. Coverage data (`.gcda`) shall be extracted via `tar` over SSH; temporary files shall be removed; the runner shall exit with the test exit code.
6. After all tests complete, `lcov --capture` and `genhtml` shall be invoked.

SSH shall use connection multiplexing (`ControlMaster=auto`, `ControlPersist=30`).

#### 5.10.5 DKMS Testing

When the DKMS flag is set, the kernel module (`.ko`) shall be copied to the VM, loaded via `insmod`, the test shall be executed, `dmesg` output shall be captured, and the module shall be removed via `rmmod`. The VM shall run the host kernel to ensure ABI compatibility.

#### 5.10.6 Cross-Compilation

Toolchain files `QEMUToolchain-{arch}.cmake` shall set the cross-compiler and the `-static` flag. Supported architectures are i386, x86_64, aarch64, and riscv64.

#### 5.10.7 Infrastructure

All infrastructure files reside in `~/git/dangstd/cmake/` and shall be symlinked to `~/.config/cmake/`: `std.cmake`, `QEMUTest.cmake`, `QEMUToolchain-{arch}.cmake`, `qemu/qemu-runner.sh`, and `qemu/create-vm.sh`.

#### 5.10.8 Test Protocol

1. External frameworks shall not be used; a project-local header-only harness shall be used
2. Exit 0 indicates pass; nonzero indicates fail
3. Registration: `add_executable(test_<mod> ...)` + `qemu_add_test(NAME <mod>_tests COMMAND test_<mod> ARCH x86_64)`
4. `qemu_add_run_target()` shall be called once after all registrations

#### 5.10.9 Project Requirements

`CMakeLists.txt` shall include `std.cmake`. `qemu_add_test()` shall be used exclusively. `qemu_add_run_target()` shall follow all test registrations. `std_invalidate_test_state(main_target)` shall be called for the primary target. External dependencies shall use `SYSTEM` includes. Project packages shall be installed on the VM. Custom libraries reside at `/usr/local/lib` on host, accessed via 9p.

---

## 6. Project Planning

Prior to implementation, all decision points shall be identified. Architecture, API design, data flow, and trade-offs shall be clarified. Implementation shall not proceed until all decision points have been confirmed.

## 7. Implementation Rules

1. Stubs shall not be used; only full implementations shall be permitted. Stubs pollute symbol tables.
2. Existing logic shall be modified incrementally.
3. Zero-based indexing shall be used. Translation shall occur at the boundary if external dependencies use one-based indexing.
4. Heap allocation (`ldg_mem_alloc`/`ldg_mem_realloc`, `malloc`/`calloc`/`realloc`) shall not be used after initialization; only `*_init` and `*_create` functions may heap-allocate. `ldg_mem_lock()` shall be called after initialization; heap allocation after the lock shall fail.
5. All post-initialization allocation shall use `ldg_mem_pool_alloc`. Fixed-size pools (`item_size` > 0) shall be used for uniform objects. Variable-size pools (`item_size` == 0) shall be used for heterogeneous allocations with shared lifetime. `ldg_mem_pool_reset()` shall be used for bulk deallocation of variable-size pools.

---

## 8. Code Exploration

AST tools shall be used before reading C source. The following invocations are representative:

```bash
ctags -x --c-kinds=f file.c                    # functions
ctags -x --c-kinds=st file.c                   # structs/typedefs
ctags -x --c-kinds=+defgstuvx file.c           # all symbols
ast-grep run --pattern 'static $RET $FUNC($$$)' --lang c file.c
ast-grep run --pattern 'typedef struct $NAME { $$$BODY }' --lang c file.c
```

## 9. Text Replacement

`sd` shall be used for all text replacement; `sed` shall not be used. A dry-run shall precede application: `sd -p 'pat' 'repl' file`. `-F` for literals. Patterns shall be specific.

---

## 10. Code Style

### 10.1 Formatting

1. Emojis and decorative symbols shall not be used
2. Line wrapping shall not be used; horizontal scrolling is acceptable
3. Visual alignment shall not be used; one space shall separate type and symbol
4. Indentation shall use 4 spaces; tabs shall not be used
5. Function definitions shall use Allman braces
6. Guard clauses shall be single-line: `if (UNLIKELY(!ptr)) { return ERR_FUNC_ARG_NULL; }`
7. Only single statements shall be inlined; nested single-statement is acceptable: `while (x) { if (y) { return z; } }`
8. A space shall follow keywords; no space shall precede function call parentheses
9. Declarations shall appear at top of scope, initialized to 0/NULL
10. Return values shall be evaluated; `(void)` cast shall not be used
11. Output redirection (`>&2`, `>/dev/null`, `2>&1`) shall not be used in scripts
12. Zero-based indexing shall be used; translation shall occur at external boundaries

### 10.2 Naming

**Files:** Module prefix shall not repeat in directory: `src/hwid/clock.c` not `hwid_clock.c`. Exception: top-level module file shall use the module name: `hwid.h`.
**Symbols:** Symbols shall include module prefix: `hwid_clock_collect()`.
**Functions:** snake_case shall be used. Pattern: `module_noun_verb`. Getters: `_get`. Setters: `_set`. Predicates: `_is`/`_has`. Callbacks: `_cb`.
**Types:** `typedef enum/struct prefix_name { ... } prefix_name_t;` Enum values shall be ALL_CAPS.
**Constants/Macros:** ALL_CAPS_SNAKE_CASE with module prefix. Magic numbers shall be given descriptive names.

### 10.3 Variables

1. Global and file-scope static variables shall not be used; forward declarations shall not be used
2. Backend abstraction: generic struct shall use `void *ctx_name`; backends cast to own type
3. Struct padding shall use `uint8_t pudding[N]`; cache-aligned: `__attribute__((aligned(64)))`
4. Only unsigned fixed-width types shall be used: `uint8_t`, `uint16_t`, `uint32_t`, `uint64_t`, `uintptr_t`. Ambiguous-width types (`size_t`, `ssize_t`, `unsigned int`, `unsigned long`) shall not be used. Signed types from external APIs shall be cast to the appropriate fixed-width unsigned type at the boundary
5. Sentinel values shall be `UINT*_MAX`; index initialization shall be `UINT*_MAX`; null shall be `0x0`
6. Boolean values shall be `uint8_t` (0 or 1). `_Bool`, `bool`, and `stdbool.h` shall not be used

### 10.4 Error Handling

Functions shall return `uint32_t` with `*_ERR_*` codes. Functions shall not return pointers or computed values directly; output shall be written through caller-provided pointer parameters (e.g., `uint32_t ldg_mem_alloc(uint64_t size, void **out)`). Getter functions returning scalar query results (e.g., `_size_get`, `_remaining_get`) may return the value directly as `uint64_t`, with `UINT*_MAX` as the error sentinel per §10.3.5. Predicate functions (`_is`, `_has`) shall return `uint8_t` (0 or 1) per §10.3.6. `UNLIKELY()` shall wrap error paths. Guard clauses shall appear at function start with early return; output parameters shall be set to `0x0` or `0` immediately after the null guard. `goto` and labels shall not be used; explicit cleanup per path is required. Warning-suppression pragmas shall not be used.

### 10.5 Comments

Comments shall be minimal: section dividers only (`// module`). Doc comments, doxygen, and inline explanations shall not be used. Brief callback hints are acceptable. Proper grammar shall be used; semicolons separate clauses.

### 10.6 Log Messages

Colons shall separate key-value pairs: `"key: %u"`. Semicolons shall separate values: `"failed; key: %u; other: %s"`.

### 10.7 Includes and Headers

Standard includes shall precede project includes. Guards shall use: `#ifndef MODULE_H` / `#define MODULE_H` / `#endif`.
Core headers shall include only `<stdint.h>` and engine headers. Third-party includes shall not appear in `.h` files. Backend handles shall be `void*` in headers, cast in `.c`. Wrapper functions shall not be used.

---

## 11. Required Abbreviations

Full words shall not be used in identifiers where an abbreviation is defined below.

**Core:** `sys=system init=initialize ctx=context conf=config desc=descriptor func=function cb=callback attr=attribute dev=device fmt=format idx=index val=value ptr=pointer ret=return err=error src=source dst=destination len=length buff=buffer addr=address alloc=allocation dealloc=deallocation cunt=count cuntr=counter pudding=padding op=operator/operand lhs=left rhs=right decl=declaration def=definition ref=reference`

**Concurrency:** `mut=mutex cond=condition sem=semaphore sync=synchronization proc=process pool=pool mngr=manager shm=shared_memory`

**Data:** `hdr=header msg=message req=request resp=response conn=connection`

**Math:** `mul=multiplication div=division mod=modulo mat=matrix vec=vector`

**Graphics:** `tex=texture mtl=material vert=vertex cam=camera fbo=framebuffer gbuff=g-buffer fx=effects grad=gradient img=image w=window`

**Physics:** `phys=physics coll=collision doll=ragdoll bphase=broadphase nphase=narrowphase anim=animation iter=iterative`

**Compiler:** `tok=token lex=lexer sym=symbol expr=expression stmt=statement reg=register imm=immediate mem=memory`

**Hardware:** `isr=interrupt_service_routine irq=interrupt_request cmd=command kb=keyboard spkr=speaker rd=read wr=write ident=identify cyl=cylinder sec=sector secs=sectors hd=head`

**Domain:** `sched=scheduler strat=strategy proj=project cplx=complexity pform=platform econ=economy lboard=leaderboard wshop=workshop enc=encrypt dec=decrypt sess=session sub=subscription`

**Prohibited:** `buf` (buff), `count` (cunt), `padding` (pudding), `float` (double), `int/short/long` (uint*_t), `size_t` (uint64_t), `ssize_t` (int64_t at boundaries), `unsigned int/long` (uint32/64_t)

---

## 12. Vale

The Vale configuration is located at `~/.config/vale/`. The following styles shall be enabled: Microsoft, write-good, proselint, and alex. The tool shall be invoked as `vale file.md`.

---

## 13. Qualified Signatures

### 13.1 Applicability

This section applies to repositories containing a `.mainproj` file. The `post-commit` hook shall invoke `qsig`; this invocation shall not be bypassed by `--no-verify`. The hook shall not be disabled.

### 13.2 Package Contents

Each commit produces `.chain/{commit-short}/`:

| File | Contents |
|------|----------|
| `manifest.txt` | Repo name, commit hash, ISO 8601 date, author, SHA-256 of every tracked file |
| `manifest.txt.ots` | OpenTimestamps Bitcoin anchor |
| `sectigo.tsr` | RFC 3161 TSR (Sectigo) |
| `digicert.tsr` | RFC 3161 TSR (DigiCert) |
| `globalsign.tsr` | RFC 3161 TSR (GlobalSign) |
| `alfasign.tsr` | RFC 3161 TSR (Alfasign, eIDAS QTSP) |
| `eth-anchor.json` | Ethereum L2 tx hash, block, chain ID, RPC URL, manifest SHA-256 |
| `qsig.asice` | ASiCE container signed with eID |

### 13.3 Timestamping

RFC 3161 timestamp queries shall be issued in parallel for each commit:

| TSA | Endpoint | Auth |
|-----|----------|------|
| Sectigo | `http://timestamp.sectigo.com/qualified` | None |
| DigiCert | `http://timestamp.digicert.com` | None |
| GlobalSign | `http://timestamp.globalsign.com/tsa/r6advanced1` | None |
| Alfasign | `https://tsa.alfasign.ro/TSAServer/get.aspx` | HTTP Basic via `pass` |

Alfasign credentials shall be stored in `pass` (`ALFASIGN_PASS_USER`, `ALFASIGN_PASS_KEY`). OpenTimestamps (`ots stamp`) shall provide Bitcoin anchoring; the `.ots` file shall be created immediately, with confirmation occurring asynchronously.

### 13.4 Blockchain Anchoring

Blockchain anchoring shall use Ethereum L2 via `cast send` (Foundry). The manifest SHA-256 shall be sent as calldata in a zero-value transaction to the sender's own address. The private key and address shall be stored in `pass` (`ETH_PASS_KEY`, `ETH_PASS_ADDR`). The RPC endpoint and chain identifier shall be specified in the configuration (`ETH_RPC_URL`, `ETH_CHAIN_ID`).

### 13.5 Electronic Signature

Every package shall be signed with eID. Default: PKCS#11 via card (`digidoc-tool sign --pkcs11`). Fallback: Smart-ID (`qdigidoc4`) if no card is detected. The ASiCE container shall contain the manifest and Sectigo TSR.

### 13.6 Chain Commits

The `qsig` tool shall stage `.chain/{short}/` and commit with the message `qsig: {short}` using `--no-verify`. A lock file (`${GIT_DIR}/.qsig-lock`) shall prevent recursion: the hook shall exit if the lock file is present. The `qsig` tool shall create the lock file before the commit and remove it after.

### 13.7 GitHub Enforcement

Repositories containing `.mainproj` shall include `qsig-verify.yml` at `.github/workflows/`. This workflow shall be configured as a required status check on the `main` and `staging` branches. For each non-chain commit, the workflow shall verify that `.chain/{short}/` exists, that the `manifest.txt` hash matches, and that at least one `.tsr`, `eth-anchor.json`, and `qsig.asice` are present. Commits prefixed with `qsig:` shall be excluded from verification. Failures shall reject the push or pull request.

### 13.8 Infrastructure

| File | Purpose |
|------|---------|
| `~/git/dangstd/bin/qsig` | Orchestrator |
| `~/git/dangstd/config/qsig/config` | Config (pass paths, RPC, chain ID, PKCS#11) |
| `~/git/dangstd/hooks/post-commit` | Invokes qsig after branchless hook |
| `~/git/dangstd/workflows/qsig-verify.yml` | GitHub Actions workflow |

Symlinks shall be created: `~/bin/qsig` shall point to dangstd; `~/.config/qsig` shall point to dangstd.

### 13.9 Credentials

All credentials shall be stored in `pass`: `qsig/alfasign/user`, `qsig/alfasign/passwd`, `qsig/bchain/eth/addr`, `qsig/bchain/eth/secret`. Paths shall be configurable via the configuration file.

### 13.10 Verification

OpenTimestamps shall be verified via `ots verify .chain/{short}/manifest.txt.ots`. RFC 3161 timestamps shall be verified via `openssl ts -verify -in {tsa}.tsr -data manifest.txt -CAfile <ca-cert>`. The eID signature shall be verified via `digidoc-tool open .chain/{short}/qsig.asice`. Manifest integrity shall be verified by comparing `git show {commit}:{file} | sha256sum` against the manifest entry. The Ethereum anchor shall be verified on a block explorer via `eth-anchor.json`.

### 13.11 Retention

The `.chain/` directory shall not be removed from the repository or its history. Files within `.chain/` shall not be modified after creation.

---

## 14. Post-Quantum Tunnel

### 14.1 Applicability

All SSH connections shall use PQ-authenticated tunnel wrapping. Naked SSH shall not be used. This requirement applies regardless of SSH PQ KEX, as SSH lacks PQ signature keys. This provision shall be revised when OpenSSH adds ML-DSA/SLH-DSA; the tunnel may be retained for defense-in-depth.

### 14.2 Architecture

```
SSH (PQ KEX) --> Kryphos (ML-DSA + ML-KEM + ChaCha20-Poly1305) --> TLS 1.3 (ML-DSA mTLS) --> Network
```

Phase 1 shall be the outer TLS 1.3 tunnel. Phase 2 shall be the Kryphos middle layer. Both phases shall use ML-DSA-87. SSH shall negotiate PQ KEX (`sntrup761x25519-sha512@openssh.com`, `mlkem768x25519-sha256`) and shall target `127.0.0.1`. The server `sshd` shall bind to `127.0.0.1` only; port 22 shall not be exposed.

### 14.3 Cryptographic Parameters

| Layer | Function | Algorithm |
|-------|----------|-----------|
| TLS auth | Signature | ML-DSA-87 (FIPS 204) |
| TLS KEX | KEM | X25519MLKEM768 |
| TLS symmetric | AEAD | ChaCha20-Poly1305 |
| Kryphos auth | Signature | ML-DSA (Dilithium-5) |
| Kryphos KEX | KEM | ML-KEM (Kyber-1024) |
| Kryphos symmetric | AEAD | ChaCha20-Poly1305 |

NIST P-curves shall not be used. SHA-2 shall not be used (except TLS 1.3 PRF, which is exempt). SLH-DSA-SHAKE-256s is available as fallback.

### 14.4 Certificate Chain

A self-signed ML-DSA-87 CA shall issue server and client certificates (ML-DSA-87).

Subject DN: `O=Ongakken Corporation OU, serialNumber=17168301, L=Tallinn, ST=Harju maakond, C=EE, street=Kalaranna tn 8/2-30, 10415`

| Cert | CN | Validity | Key Usage |
|------|----|----------|-----------|
| CA | `Ongakken Corporation OU PQ Tunnel CA` | 3650d | Cert Sign, CRL Sign |
| Server | `{fqdn}` | 365d | Digital Sig, Key Encipher |
| Client | `{full_name}` (+emailAddress) | 365d | Digital Sig, Key Encipher |

Keys and certificates shall be stored in `pass`: `pqtun/ca/key|cert`, `pqtun/server/{host}/key|cert`, `pqtun/client/{host}/key|cert`. Scripts shall extract credentials from `pass` at runtime. Deployment shall be performed via `pqtun deploy {hostname}`, which shall install credentials to `/etc/pqtun/`.

### 14.5 TLS Tunnel

The TLS tunnel shall use `stunnel` or an equivalent tool (OpenSSL 3.6+).

**Server:** The server shall listen on port 2222 (`PQTUN_PORT`) and forward to `127.0.0.1:22`. Only TLSv1.3 shall be permitted. Mutual TLS shall be required (verify=2). Certificates shall reside at `/etc/pqtun/`.
**Client:** The client shall listen on `127.0.0.1:{local_port}` and connect to `{server}:2222`. Only TLSv1.3 shall be permitted; verify=2. Certificates shall reside at `~/.config/pqtun/`.
**SSH:** The SSH configuration shall specify `HostName 127.0.0.1`, `Port {local_port}`, and `ProxyCommand none`.

### 14.6 Server Lockdown

After the tunnel has been verified, `sshd` shall be configured with `ListenAddress 127.0.0.1` and the firewall shall block port 22. Only `PQTUN_PORT` shall be externally accessible. Lockdown shall not proceed until the tunnel has been verified.

### 14.7 Infrastructure

The tunnel management tool resides at `~/git/dangstd/bin/pqtun`. The certificate generation tool resides at `~/git/dangstd/bin/pqtun-certgen`. Configuration and templates reside at `~/git/dangstd/config/pqtun/`. Symlinks shall be created: `~/bin/pqtun` and `~/bin/pqtun-certgen` shall point to dangstd; `~/.config/pqtun` shall point to dangstd.

### 14.8 Credentials

All credentials shall be stored in `pass` (§14.4). The deploy operation shall extract credentials to `/etc/pqtun/` (keys with mode 0600, certificates with mode 0644). The client shall extract credentials to a temporary directory at startup and shall erase them on shutdown.

### 14.9 Renewal

Server and client certificates shall be renewed before expiry: `pqtun-certgen renew`. All certificates shall be reissued on CA renewal. Expiration shall be monitored via cron/timers.

### 14.10 Verification

Tunnel status shall be verified via `pqtun status {host}`, which shall check TLS, certificate, and SSH connectivity. The certificate chain shall be verified via `openssl verify -CAfile ca.pem server.pem`. The ML-DSA-87 algorithm shall be confirmed via `openssl x509 -in server.pem -text -noout`.

---

## 15. EMIRU Binary Format

32-byte header executable binary format for loading user-space processes. All multi-byte fields shall be little-endian.

### 15.1 Header Layout

| Offset | Size | Field | Type | Constraints |
|--------|------|-------|------|-------------|
| 0 | 6 | `magic` | `byte[6]` | Shall be `"EMIRU\0"` (null-terminated) |
| 6 | 1 | `rev` | `byte` | Shall be 1 |
| 7 | 1 | `ring` | `byte` | Shall be 0, 1, 2, or 3 |
| 8 | 1 | `flags` | `byte` | Bit 0: PIC (position-independent code); bits 1-7 reserved |
| 9 | 1 | `reserved0` | `byte` | Shall be zero on encode; shall be ignored on decode |
| 10 | 2 | `prog_rev` | `word` | Application-defined program revision |
| 12 | 4 | `entry` | `dword` | Offset relative to text section start; shall be less than `text_size` |
| 16 | 4 | `text_size` | `dword` | Text section size in bytes; shall be greater than 0 |
| 20 | 4 | `data_size` | `dword` | Data section size in bytes; may be 0 |
| 24 | 4 | `bss_size` | `dword` | BSS declared size in bytes; not present in binary |
| 28 | 4 | `reserved1` | `dword` | Shall be zero on encode; shall be ignored on decode |

### 15.2 Section Layout

```
[header 32B][text (text_size bytes)][data (data_size bytes)]
```

The binary shall contain at least `32 + text_size + data_size` bytes. BSS is declared size only; the loader shall zero-initialize `bss_size` bytes immediately following the data section in memory. No arbitrary maximum size is imposed; the buffer length parameter constrains.

### 15.3 Validation

If `magic` does not match, the behavior is undefined. If `rev` is not 1, the binary shall be rejected. If `ring` exceeds 3, the binary shall be rejected. If `text_size` is 0, or `entry` is not less than `text_size`, the entry point is invalid and the binary shall be rejected. If `text_size + data_size` overflows, or the buffer is shorter than the required minimum, the binary is truncated and shall be rejected.

---

## 16. EMIEMI Transfer Protocol

Serial binary transfer protocol for sending payloads over byte-oriented transports. The protocol has no version field, no compression, and no encryption.

### 16.1 Frame Layout

```
<<EMIEMI>XXXXXX>[payload bytes]<<EMIEMI>>
```

| Component | Size | Constraints |
|-----------|------|-------------|
| Start marker | 9 bytes | Shall be ASCII `<<EMIEMI>` |
| Size field | 6 bytes | Shall be 6 uppercase hexadecimal ASCII digits (`0-9`, `A-F`); big-endian digit order |
| Delimiter | 1 byte | Shall be ASCII `>` (0x3E) |
| Payload | variable | Raw bytes; length as declared by size field |
| End marker | 10 bytes | Shall be ASCII `<<EMIEMI>>` |

Total overhead: 26 bytes.

### 16.2 Size Field

The size field shall consist of exactly 6 uppercase hexadecimal ASCII digits. Lowercase hexadecimal digits shall not be accepted. The maximum payload size shall be 16,777,215 bytes (0xFFFFFF). If the size field contains characters outside `0-9` or `A-F`, the frame shall be rejected.

### 16.3 Integrity

FNV-1a (32-bit) shall be computed independently by sender and receiver over the payload bytes. The offset basis shall be 2,166,136,261; the prime shall be 16,777,619. The hash is not included in the wire format; the caller shall compare sender and receiver hashes to detect corruption.

### 16.4 Marker Collision

The payload may contain byte sequences identical to the start or end markers. The size field disambiguates payload boundaries; the end marker position is deterministic from the declared payload size.

---

## Appendix A: Document History

| Ver | Date | Changes |
|-----|------|---------|
| 1.0 | 2026-01-23 | Initial |
| 1.1 | 2026-01-24 | Test state tracking; `.test-state` gitignore |
| 1.2 | 2026-01-27 | QEMU/KVM enforcement; dangstd symlinks |
| 1.3 | 2026-01-27 | §5.10 rewrite: persistent VMs, SSH runner, 9p, cloud-init |
| 1.4 | 2026-01-29 | `std.cmake`: C99, POSIX, pedantic, SYSTEM includes |
| 1.5 | 2026-01-30 | ISO/IEC conformance language; expanded error codes |
| 1.6 | 2026-01-30 | Restructured: §3 Terms; §4 libdangling before Code Style |
| 1.7 | 2026-02-07 | §3 priority levels: BLUE/ULTRAVIOLET/PRIORITY taxonomy |
| 1.8 | 2026-02-07 | §13 Qualified Signatures |
| 1.9 | 2026-02-07 | §14 Post-Quantum Tunnel |
| 2.0 | 2026-02-08 | §4.12 Protocol module; §15 EMIRU Binary Format; §16 EMIEMI Transfer Protocol; §4.2 error code range update |
| 2.1 | 2026-02-10 | §4.4 pool API update (variable-size, reset, query); §7.4 post-init allocation discipline; `ldg_mem_lock` |
| 2.2 | 2026-02-10 | §10.3.4 explicit `size_t`/`ssize_t`/`unsigned int/long` prohibition; §11 prohibited list updated |
| 2.3 | 2026-02-10 | §10.4 pointer return prohibition; out-param mandate; getter scalar exception with `UINT*_MAX` sentinel; §4.4 mem API signatures updated |
| 2.4 | 2026-02-10 | Prose standardization: fragment sentences replaced with complete "shall" sentences per ISO/IEC 9899 and IEEE Std 1003.1 conventions; arrow notation and equals-sign definitions eliminated; missing articles and verbs added throughout §§1, 5, 6, 7, 8, 9, 11, 12, 13, 14 |
| 2.5 | 2026-02-10 | §10.3.6 boolean values shall be `uint8_t`; §10.4 predicate functions (`_is`, `_has`) shall return `uint8_t` |
