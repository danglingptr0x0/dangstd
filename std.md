```
Ongakken Corporation OU                                                OC Std 2.0
Kalaranna tn 8/2-30, 10415                                       (Revision of 1.9)
Tallinn, Harju maakond
Estonia
Registry code: 17168301
```

```
                                         @@@@@@@@@@@@@@@@@@
                                  @@@@@@@                  @@@@@@@
                              @@@@@                              @@@@@
                           @@@         @@@@@@@@@@@@@@   @@@@@         @@@
                        @@@      @@@@@@            @@   @@@@@@@@@@@     @@@@
                      @@@     @@@@@      @@@@@@@   @@   @@@@@      @@@     @@@
                    @@     @@@@@@@@@@@@@@       @@@@@          @@@   @@@@     @@
                   @@   @@@@@@@@@@@@@@@@   @@@   @@@@         @@@@@  @@@@@@@   @@@
                                           @@@@  @@   @@@@@@         @    @@@    @@@
                    @@@@@@@@@@   @@@@@@@@        @@     @@@@@@    @@@@@@@@@@@@@    @@
                           @@@   @@@@@@@@@@    @@@   @@@@   @@@@@@@@@@@    @@@@@@   @@@
                            @@   @@@@@@@@@@@@@@@@@@@@@@        @@  @@        @@@@@    @@
                            @@                          @@@@@  @@ @@   @@@@   @@@@@    @@
                             @@                          @@@   @@  @@  @@@    @   @@    @@
          @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@       @@    @       @@@    @@@   @@
         @                   @          @@@@        @ @@@@@@@@       @@@  @@@@@@@@@@@@@  @@@
        @@   @@@@  @@@@@@@   @@       @@         @@                  @@@  @@@@      @@@   @@
       @@   @@@@@   @@@@@@   @@     @@@    @@@@@                     @@@  @@@         @@   @@
      @@   @@@@@@   @@  @@   @@    @@    @@@                         @@@  @@@  @@@@   @@@   @@
      @@   @@  @@   @@@@@@   @@@@@@    @@@                           @@@  @@@    @    @@@   @@
     @@   @@   @@   @@@@       @@@@   @@                         @@@@@@@  @@@@      @@@@@@   @@
     @@   @@   @@   @@@   @@@   @@   @@                        @           @@@@@  @@@   @@   @@
     @@   @    @@   @@@   @@@   @   @@                        @@          @  @@@   @@   @@@  @@
    @@   @@    @@   @@@@       @@  @@@                        @@   @@@@@      @@  @@@@@@@@@   @@
    @@   @@    @@   @@@@@@   @@@   @@                          @@   @@       @@@  @@@@@@@@@   @@
    @@   @@   @@@  @@@@@    @@@@  @@@                          @@   @@   @@@@@@@              @@
    @@   @@ @@        @@      @@  @@                           @@@  @@@@@      @@@@@@@@@@@@@  @@
    @@   @@@@@  @@@@   @@     @@  @@                            @@  @@@@   @@   @@@@@@@@@@@@  @@
    @@   @@@@@  @@@@   @@@@@@@@@  @@                            @@  @@@   @@@@                @@
    @@   @@  @@       @@    @@@@  @@                            @@  @@@@        @@@@@@@@@@@@  @@
    @@   @@   @@@@@@@@        @@  @@@                          @@@  @@@@@     @@@@      @@@   @@
    @@   @@       @@@  @@@@@  @@   @@                          @@   @@    @@@@@@@@@@     @@   @@
    @@   @@        @@   @@@   @@   @@                          @@   @@       @@@@    @@@@@@   @@
    @@   @@        @@@       @@@@   @@                        @@   @@@@@@@@@@@@        @@@@   @
     @@   @@  @@@@@@@@@@@  @@@@@@   @@                        @                  @@@@   @@@  @@
     @@   @@@@       @@@@  @@@@@@@   @@                        @                 @@@@   @@   @@
     @@   @@@   @@@   @@@  @@@@@@@@   @@@                        @@@@@@@@@@@@@@       @@@@   @
      @@   @@  @@@@@          @@ @@@   @@@                                    @@@@@@@@@@@   @@
      @@   @@@        @@@@@@  @@   @@    @@@@                                @@@@@@@@@@@    @
       @@   @@@@    @@@ @@@@  @@    @@@     @@@@@@              @@@@@@@@@@@@@@@@@@@@@@@@   @@
        @@   @@@@@@      @@@  @@     @@@@          @@          @                          @@
        @@@   @@         @@@  @@@@@@@@@@@@@@@      @@@@@@      @@  @@@@@@@@@@@@@@@@@@@@@@@
         @@    @@        @@@  @@@@     @@@@@@@@@@         @   @@@  @@@@
          @@    @@       @@@  @@    @    @@@@@@@@  @@@@   @@@@@@    @@@
           @@@   @@@@@@@@@@@  @@  @@@@@            @@@@   @@@@        @@      @@@@@
             @@               @@    @@   @@@@@@@@@@@@@@   @@@   @@@@   @   @@      @@
              @@              @@@@      @@@@@@@@     @@   @@@@   @@    @  @@    @    @
                 @@@@@@@@@@@@     @@@@@@   @@@@@@@ @@@@   @@@@@      @@   @@  @@@@@  @@
                           @@     @@@@@@@@@@      @@@      @@@@@@@@@@    @@@@   @    @
                        @@@@@@@@@@@@@@@@@@    @    @    @    @@        @@@@        @@
                       @                    @@@@@  @  @@@@@  @@      @@@@    @@@@@@
                       @@    @@@@@@@@@@@@@@   @    @         @@  @@@@      @@@
                         @@@      @@@@@@@@@@      @@@      @@@@@@@      @@@
                           @@@@@       @@@@@@@@@@@@@@@@@@@@@@       @@@@
                               @@@@@                            @@@@@
                                    @@@@@@@              @@@@@@@
                                           @@@@@@@@@@@@@@
```

# Global Development Standards

Software Development -- Build Systems, Code Style, and Tooling

## 1. Scope

1 Requirements for software development across all repositories; project-local standards may override specific provisions.
2 Covers version control, code style, build systems, and libdangling usage.
3 Extends and overrides ISO/IEC 9899:1999 (C99) and IEEE Std 1003.1-2017 (POSIX.1-2017) where applicable.

## 2. Conformance

1 In this standard, "shall" is to be interpreted as a requirement on an implementation or on a program; conversely, "shall not" is to be interpreted as a prohibition.
2 If a "shall" or "shall not" requirement is violated, the behavior is undefined unless otherwise specified.
3 "Should" indicates a recommended practice; deviation requires justification. "May" indicates optional behavior.
4 "Undefined behavior" results from use of an invalid program construct. "Unspecified behavior" results from use of a valid construct where two or more possibilities exist. "Implementation-defined behavior" results from use of a valid construct where the choice shall be documented.

## 3. Terms and Definitions

| Term | Definition |
|------|-----------|
| Coccinelle | Semantic patch tool for C (`spatch`) |
| Vale | Prose linting tool for style guides |
| sd | Text replacement tool; used in place of `sed` |
| ctags | Source code indexing for symbol navigation |
| ast-grep | Structural code search matching AST patterns |
| guard clause | Conditional at function start, returns early on invalid input |
| Allman braces | Opening brace on its own line, aligned with control statement |
| snake_case | Lowercase words separated by underscores |

Priority levels (descending severity): **BLUE** (security-critical, maximum) > **ULTRAVIOLET** (high-severity security) > **PRIORITY** (elevated importance) > **unmarked** (default, equal among themselves).

---

## 4. libdangling

Canonical utility library for all C projects; shall be used for all utilities it provides; redefinition prohibited.
Install: `pkg-config --cflags --libs dangling` | Source: `~/git/libdangling`

### 4.1 Macros (`core/macros.h`, `core/bits.h`)

Branch hints: `LDG_LIKELY()`, `LDG_UNLIKELY()` | Sizes: `LDG_KIB/MIB/GIB` | Time: `LDG_MS_PER_SEC`, `LDG_NS_PER_MS/SEC`, `LDG_SECS_PER_MIN/HOUR` | Bases: `LDG_BASE_DECIMAL/HEX` | Byte/bit: `LDG_BYTE_BITS/MASK/SHIFT_*`, `LDG_NIBBLE_BITS/MASK`, `LDG_WORD_BYTES`, `LDG_IS_POW2()` | String: `LDG_STR_TERM(_SIZE)` | Init: `LDG_STRUCT_ZERO_INIT`, `LDG_ARR_ZERO_INIT` | Alignment: `LDG_AMD64_CACHE_LINE_WIDTH`, `LDG_ALIGNED`, `LDG_ALIGNED_UP/DOWN()`

### 4.2 Error Codes (`core/err.h`)

Reserved range 0-690. Project-specific: 700-990. Generic conditions shall use libdangling codes.

| Range | Category |
|-------|----------|
| 0 | `LDG_ERR_AOK` |
| 1-99 | Generic: `_FUNC_ARG_NULL/_INVALID`, `_ALLOC_NULL`, `_NOT_INIT`, `_FULL`, `_OVERFLOW`, `_EMPTY`, `_BUSY`, `_INVALID`, `_TIMEOUT`, `_NOT_FOUND`, `_EXISTS`, `_DENIED`, `_UNSUPPORTED`, `_CANCELLED`, `_INTERRUPTED`, `_RANGE`, `_BOUNDS`, `_WOULD_BLOCK`, `_AGAIN`, `_CLOSED`, `_EOF` |
| 100-199 | Memory: `_MEM_BAD`, `_STR_TRUNC`, `_MEMMOVE_ALLOCD`, `_SENTINEL`, `_POOL_FULL/_INVALID`, `_DOUBLE_FREE`, `_ALIGNMENT`, `_CORRUPTION` |
| 200-299 | I/O: `_IO_NOT_FOUND`, `_READ/_WRITE/_FORMAT/_OPEN/_CLOSE/_SEEK/_FLUSH/_PERMISSION/_IS_DIR/_NOT_DIR` |
| 300-399 | Time: `_TIME_CORE_MIGRATED`, `_NOT_CALIBRATED` |
| 400-499 | Network: `_NET_INIT/_PERFORM/_TIMEOUT/_CONN/_DISCONNECTED/_REFUSED/_UNREACHABLE/_DNS/_TLS/_PROTOCOL/_RESET/_SEND/_RECV` |
| 500-599 | String: `_STR_TRUNC/_OVERLAP/_INVALID/_EMPTY/_FORMAT` |
| 600-649 | Audio: `LDG_ERR_AUDIO_*` |
| 650-690 | Protocol: `LDG_ERR_PROTO_EMIRU_*`, `LDG_ERR_PROTO_EMIEMI_*` |

Logging: `LDG_ERRLOG_ERR()`, `LDG_ERRLOG_WARN()`, `LDG_ERRLOG_INFO()`

### 4.3 Types (`core/types.h`)

`ldg_byte_t`, `ldg_word_t`, `ldg_dword_t`, `ldg_qword_t` (aliases: `byte_t`, `word_t`, `dword_t`, `qword_t`)

### 4.4 Memory (`mem/`)

`mem.h`: `ldg_mem_init/shutdown/alloc/realloc/dealloc()`, `ldg_mem_stats_get/leaks_dump/valid_is/size_get()`
`alloc.h`: `ldg_mem_pool_create/destroy/alloc/dealloc()`
`secure.h`: `ldg_mem_secure_zero/copy/cmp/cmov/neq()`

### 4.5 String (`str/str.h`)

`ldg_strrbrcpy()`, `ldg_str_to_dec()`, `ldg_hex_str_is()`, `ldg_hex_to_bytes/dword()`, `ldg_byte_to_hex()`, `ldg_dword_to_hex()`, `ldg_char_*_is()` predicates

### 4.6 Time (`time/`)

`time.h`: `ldg_time_init/tick/get/monotonic_get/epoch_ms_get/epoch_ns_get/dt_get/dt_smoothed_get/fps_get/frame_cunt_get()`
`perf.h`: High-resolution performance timing

### 4.7 Threading (`thread/`)

`sync.h`: `ldg_mut_t` (`init/lock/unlock/trylock/destroy`); `ldg_cond_t` (`init/wait/timedwait/signal/broadcast/destroy`); `ldg_sem_t` (`init/open/wait/trywait/post/destroy`)
`spsc.h`: `ldg_spsc_queue_t`, `ldg_spsc_init/push/pop/peek/cunt/empty/full/shutdown()`
`pool.h`: `ldg_thread_pool_t`, `ldg_thread_pool_init/start/stop/shutdown/worker_cunt_get()`

### 4.8 Math (`math/linalg.h`)

`ldg_vec3_*()`, `ldg_mat3_*()` (add, sub, scale, dot, cross, mul, inv, det, trace, transpose)

### 4.9 Network (`net/curl.h`)

`ldg_curl_multi_ctx_t`, `ldg_curl_multi_ctx_create/req_add/perform/progress_get/ctx_destroy()`, `ldg_curl_resp_t`

### 4.10 Parsing (`parse/parse.h`)

`ldg_tok_t`, `ldg_tok_arr_t`, `ldg_parse_tokenize()`, `ldg_parse_streq()`

### 4.11 x86-64 (`arch/x86_64/`)

`fence.h`: `LDG_MFENCE/SFENCE/LFENCE/BARRIER/PAUSE`, `LDG_SMP_MB/WMB/RMB/SIG_FENCE()`
`atomic.h`: `LDG_READ_ONCE/WRITE_ONCE()`, `_AGGREGATE()` variants, `LDG_LOAD_ACQUIRE/STORE_RELEASE()`, `LDG_FETCH_ADD/SUB()`, `LDG_ADD_FETCH/SUB_FETCH()`, `LDG_CAS/CAS_WEAK()`
`prefetch.h`: `LDG_PREFETCH_R/W/NTA()`
`tsc.h`: `ldg_tsc_ctx_t`, `ldg_rdtsc/rdtscp()`, `ldg_tsc_calibrate/sample/serialized_sample/serialize/delta/to_sec()`
`cpuid.h`: `ldg_cpuid()`, `ldg_cpuid_features_t`, `ldg_cpuid_features_get/vendor_get/brand_get()`, `ldg_cpu_core_id_get/relax()`
`syscall.h`: `ldg_syscall0()` through `ldg_syscall4()`, `LDG_SYS_*` constants

### 4.12 Protocol (`proto/`)

`emiru.h`: `ldg_emiru_hdr_t`, `ldg_emiru_decoded_t`, `ldg_emiru_hdr_validate()`, `ldg_emiru_decode()`, `ldg_emiru_encode()`, `ldg_emiru_encoded_size_get()`
`emiemi.h`: `ldg_emiemi_io_ctx_t`, `ldg_emiemi_hdr_recv()`, `ldg_emiemi_payload_recv()`, `ldg_emiemi_recv()`, `ldg_emiemi_send()`, `ldg_emiemi_encode()`, `ldg_emiemi_decode()`, `ldg_emiemi_fnv1a()`, `ldg_emiemi_encoded_size_get()`

---

## 5. Version Control

### 5.1 Global Hooks

Location: `~/.config/git/hooks/` via `git config --global core.hooksPath`.

| Hook | Function |
|------|----------|
| `pre-commit` | Branch validation, binary blocking, formatting, static analysis |
| `prepare-commit-msg` | Auto-populate `type(scope):` from branch name |
| `commit-msg` | Conventional commit validation, scope matching |
| `pre-push` | Label warnings, WIP blocking, secrets scan, sanitizer tests |
| `pre-rebase` | Warning on pushed branches, blocking main/staging |
| `post-commit` | Qualified signature generation via `qsig` (§13) |
| `post-checkout` | compile_commands.json regeneration, ccache stats, stale branch warnings |

### 5.2 Scripts

Location: `~/.config/git/bin/` (on PATH). `git bump` = next semver; `git bump --apply` = git flow release; `git release-notes` = changelog via git-cliff.

### 5.3 Coccinelle

Location: `~/.config/git/cocci/`. Run: `run-all.sh /path/to/src` (report) or `run-all.sh /path/to/src --fix` (apply).

### 5.4 Branch Naming

Pattern: `type/name`. Types: `feat/ fix/ hot/ rel/ misc/ docs/ refactor/ test/ chore/ perf/ ci/ build/ revert/`. Non-conforming names result in undefined behavior.

### 5.5 Commit Messages

Pattern: `type(scope): description`. Length shall be 75-100 characters. Imperative mood; the description shall not end with a period. Only the description shall be provided; `type(scope):` is auto-populated by hook.

### 5.6 Commit Atomicity

One subsystem per commit (directory path + base filename). Scope shall match subsystem. `.h`/`.c` with same base name shall be committed together. `CMakeLists.txt` constitutes its own subsystem.

### 5.7 Test State Tracking

A minimum of 50% coverage shall be achieved before committing. Commands: `git test-state save/check`. Targets: `make tests` (build only), `make tests-run` (build + QEMU run + coverage + test-state save).

Pre-commit hook: checks `.test-state` hash -> runs `make tests-run` if invalid -> verifies 50% coverage -> saves state -> blocks on failure.

`std_invalidate_test_state(main_target)` handles recompilation invalidation. Coverage via `std.cmake` with `STD_DEBUG=ON`. `.test-state` globally gitignored. Reports in `build/coverage_html/`.

### 5.8 Git Invocation

`git -C <path>` shall not be used; run from repo root.

### 5.9 Git Flow

`git flow feature start/finish name` (feat/name, merges to staging). `git flow release start/finish 1.2.0` (rel/1.2.0, merges and tags).

### 5.10 QEMU Test Execution

All tests shall run inside persistent QEMU/KVM VMs (libvirt). Host-native execution shall not be used. Rationale: DKMS modules may panic host; single infrastructure for all tests.

#### 5.10.1 VM Architecture

Persistent VMs via `virsh`/`virt-install` (`qemu:///system`), provisioned from cloud images via `cloud-init`. Script: `~/git/dangstd/cmake/qemu/create-vm.sh dev|deploy`. Naming: `qemu-test-{variant}-{arch}`.

| Variant | Base | Purpose |
|---------|------|---------|
| `dev` | Arch Linux | Matches host kernel/glibc/toolchain; zero delta |
| `deploy` | Debian 12 | Older glibc (2.36) compatibility; static binaries only |

`dev` runs host kernel (`linux-zen`), version-locked via `IgnorePkg` on both host and VM.

VM config: 12 vCPUs, 4096 MiB RAM, 20 GiB qcow2, libvirt NAT, SSH via RSA 8192 key (`~/.ssh/id_qemu_test`), sshd MaxStartups 50:30:100, MaxSessions 50.

#### 5.10.2 Shared Libraries

Custom libs exposed via virtio-9p read-only shares:

| 9p Tag | Host -> VM Mount | Mode |
|--------|-----------------|------|
| `hostlib` | `/usr/local/lib` -> `/usr/local/lib` | ro |
| `hostinclude` | `/usr/local/include` -> `/usr/local/include` | ro |

Persisted in VM `/etc/fstab`. VM has `/usr/local/lib` in `ld.so.conf`, `/usr/local/lib/pkgconfig` in `PKG_CONFIG_PATH`. Distribution packages installed directly on VM.

#### 5.10.3 CMake Integration

```cmake
list(APPEND CMAKE_MODULE_PATH "$ENV{HOME}/.config/cmake")
include(std)
```

`std.cmake` enforces: C99 (`CMAKE_C_STANDARD 99`, `CMAKE_C_EXTENSIONS OFF`), POSIX.1-2008, `-pedantic -Werror=pedantic`, debug via `-DSTD_DEBUG=ON` (`-g -O0` + coverage). External deps use `SYSTEM` includes.

Test registration:
```cmake
qemu_add_test(NAME core_tests COMMAND test_core ARCH x86_64)
qemu_add_test(NAME core_deploy COMMAND test_core ARCH x86_64 VARIANT deploy)
qemu_add_cross_test(NAME core COMMAND test_core ARCHS x86_64 aarch64 riscv64)
qemu_add_test(NAME driver_test COMMAND test_driver ARCH x86_64 DKMS KERNEL_MODULE mydriver)
qemu_add_run_target()
```

`qemu_add_test()` parameters: NAME (required), COMMAND (required), ARCH (x86_64), VARIANT (dev), TIMEOUT (120), DKMS (off), KERNEL_MODULE.

Targets: `make run-<name>` (single test), `make tests-run` (full suite `-j 12` + lcov + genhtml + test-state save).

#### 5.10.4 Execution Flow

1. CTest -> `qemu-runner.sh` per binary (`-j 12`)
2. Resolve VM IP (`virsh domifaddr`), verify running
3. `scp` binary to VM (`/tmp/qemu-test-$$/test_binary`)
4. `ssh` execute with `GCOV_PREFIX`/`GCOV_PREFIX_STRIP`
5. Extract `.gcda` via `tar` over SSH, clean up, exit with test exit code
6. After all: `lcov --capture` + `genhtml`

SSH uses connection multiplexing (`ControlMaster=auto`, `ControlPersist=30`).

#### 5.10.5 DKMS Testing

DKMS flag: copy `.ko` -> `insmod` -> run test -> capture `dmesg` -> `rmmod`. VM runs host kernel for ABI compat.

#### 5.10.6 Cross-Compilation

Toolchain files `QEMUToolchain-{arch}.cmake` set cross-compiler + `-static`. Architectures: i386, x86_64, aarch64, riscv64.

#### 5.10.7 Infrastructure

All in `~/git/dangstd/cmake/`, symlinked to `~/.config/cmake/`: `std.cmake`, `QEMUTest.cmake`, `QEMUToolchain-{arch}.cmake`, `qemu/qemu-runner.sh`, `qemu/create-vm.sh`.

#### 5.10.8 Test Protocol

1. External frameworks shall not be used; a project-local header-only harness shall be used
2. Exit 0 indicates pass; nonzero indicates fail
3. Registration: `add_executable(test_<mod> ...)` + `qemu_add_test(NAME <mod>_tests COMMAND test_<mod> ARCH x86_64)`
4. `qemu_add_run_target()` shall be called once after all registrations

#### 5.10.9 Project Requirements

`CMakeLists.txt` shall include `std.cmake`. `qemu_add_test()` shall be used exclusively. `qemu_add_run_target()` shall follow all test registrations. `std_invalidate_test_state(main_target)` shall be called for the primary target. External dependencies shall use `SYSTEM` includes. Project packages shall be installed on the VM. Custom libraries reside at `/usr/local/lib` on host, accessed via 9p.

---

## 6. Project Planning

Prior to implementation, all decision points shall be identified; architecture, API design, data flow, and trade-offs shall be clarified. Implementation shall not proceed until confirmed.

## 7. Implementation Rules

1. Stubs shall not be used; only full implementations are permitted (stubs pollute symbol tables)
2. Existing logic shall be modified incrementally
3. Zero-based indexing shall be used; translation shall occur at boundary if external dependencies use one-based

---

## 8. Code Exploration

AST tools shall be used before reading C source:
```bash
ctags -x --c-kinds=f file.c                    # functions
ctags -x --c-kinds=st file.c                   # structs/typedefs
ctags -x --c-kinds=+defgstuvx file.c           # all symbols
ast-grep run --pattern 'static $RET $FUNC($$$)' --lang c file.c
ast-grep run --pattern 'typedef struct $NAME { $$$BODY }' --lang c file.c
```

## 9. Text Replacement

`sd` shall be used for all text replacement; `sed` shall not be used. A dry-run shall precede application: `sd -p 'pat' 'repl' file`. `-F` for literals. Patterns shall be specific.

---

## 10. Code Style

### 10.1 Formatting

1. Emojis and decorative symbols shall not be used
2. Line wrapping shall not be used; horizontal scrolling is acceptable
3. Visual alignment shall not be used; one space shall separate type and symbol
4. Indentation shall use 4 spaces; tabs shall not be used
5. Function definitions shall use Allman braces
6. Guard clauses shall be single-line: `if (UNLIKELY(!ptr)) { return ERR_FUNC_ARG_NULL; }`
7. Only single statements shall be inlined; nested single-statement is acceptable: `while (x) { if (y) { return z; } }`
8. A space shall follow keywords; no space shall precede function call parentheses
9. Declarations shall appear at top of scope, initialized to 0/NULL
10. Return values shall be evaluated; `(void)` cast shall not be used
11. Output redirection (`>&2`, `>/dev/null`, `2>&1`) shall not be used in scripts
12. Zero-based indexing shall be used; translation shall occur at external boundaries

### 10.2 Naming

**Files:** Module prefix shall not repeat in directory: `src/hwid/clock.c` not `hwid_clock.c`. Exception: top-level module file shall use the module name: `hwid.h`.
**Symbols:** Symbols shall include module prefix: `hwid_clock_collect()`.
**Functions:** snake_case shall be used. Pattern: `module_noun_verb`. Getters: `_get`. Setters: `_set`. Predicates: `_is`/`_has`. Callbacks: `_cb`.
**Types:** `typedef enum/struct prefix_name { ... } prefix_name_t;` Enum values shall be ALL_CAPS.
**Constants/Macros:** ALL_CAPS_SNAKE_CASE with module prefix. Magic numbers shall be given descriptive names.

### 10.3 Variables

1. Global and file-scope static variables shall not be used; forward declarations shall not be used
2. Backend abstraction: generic struct shall use `void *ctx_name`; backends cast to own type
3. Struct padding shall use `uint8_t pudding[N]`; cache-aligned: `__attribute__((aligned(64)))`
4. Only unsigned types shall be used: `uint8/16/32/64_t`, `uintptr_t`; signed casts shall occur only at external API boundaries
5. Sentinel values shall be `UINT*_MAX`; index initialization shall be `UINT*_MAX`; null shall be `0x0`

### 10.4 Error Handling

Functions shall return `uint32_t` with `*_ERR_*` codes. `UNLIKELY()` shall wrap error paths. Guard clauses shall appear at function start with early return. `goto` and labels shall not be used; explicit cleanup per path is required. Warning-suppression pragmas shall not be used.

### 10.5 Comments

Comments shall be minimal: section dividers only (`// module`). Doc comments, doxygen, and inline explanations shall not be used. Brief callback hints are acceptable. Proper grammar shall be used; semicolons separate clauses.

### 10.6 Log Messages

Colons shall separate key-value pairs: `"key: %u"`. Semicolons shall separate values: `"failed; key: %u; other: %s"`.

### 10.7 Includes and Headers

Standard includes shall precede project includes. Guards shall use: `#ifndef MODULE_H` / `#define MODULE_H` / `#endif`.
Core headers shall include only `<stdint.h>`, `<stddef.h>`, and engine headers. Third-party includes shall not appear in `.h` files. Backend handles shall be `void*` in headers, cast in `.c`. Wrapper functions shall not be used.

---

## 11. Required Abbreviations

Full words shall be avoided in identifiers.

**Core:** `sys=system init=initialize ctx=context conf=config desc=descriptor func=function cb=callback attr=attribute dev=device fmt=format idx=index val=value ptr=pointer ret=return err=error src=source dst=destination len=length buff=buffer addr=address alloc=allocation dealloc=deallocation cunt=count cuntr=counter pudding=padding op=operator/operand lhs=left rhs=right decl=declaration def=definition ref=reference`

**Concurrency:** `mut=mutex cond=condition sem=semaphore sync=synchronization proc=process pool=pool mngr=manager shm=shared_memory`

**Data:** `hdr=header msg=message req=request resp=response conn=connection`

**Math:** `mul=multiplication div=division mod=modulo mat=matrix vec=vector`

**Graphics:** `tex=texture mtl=material vert=vertex cam=camera fbo=framebuffer gbuff=g-buffer fx=effects grad=gradient img=image w=window`

**Physics:** `phys=physics coll=collision doll=ragdoll bphase=broadphase nphase=narrowphase anim=animation iter=iterative`

**Compiler:** `tok=token lex=lexer sym=symbol expr=expression stmt=statement reg=register imm=immediate mem=memory`

**Hardware:** `isr=interrupt_service_routine irq=interrupt_request cmd=command kb=keyboard spkr=speaker rd=read wr=write ident=identify cyl=cylinder sec=sector secs=sectors hd=head`

**Domain:** `sched=scheduler strat=strategy proj=project cplx=complexity pform=platform econ=economy lboard=leaderboard wshop=workshop enc=encrypt dec=decrypt sess=session sub=subscription`

**Prohibited:** `buf` (buff), `count` (cunt), `padding` (pudding), `float` (double), `int/short/long` (uint*_t)

---

## 12. Vale

Config: `~/.config/vale/`. Styles: Microsoft, write-good, proselint, alex. Run: `vale file.md`.

---

## 13. Qualified Signatures

### 13.1 Applicability

Applies to repos with `.mainproj`. `post-commit` hook invokes `qsig`; not bypassed by `--no-verify`. Hook shall not be disabled.

### 13.2 Package Contents

Each commit produces `.chain/{commit-short}/`:

| File | Contents |
|------|----------|
| `manifest.txt` | Repo name, commit hash, ISO 8601 date, author, SHA-256 of every tracked file |
| `manifest.txt.ots` | OpenTimestamps Bitcoin anchor |
| `sectigo.tsr` | RFC 3161 TSR (Sectigo) |
| `digicert.tsr` | RFC 3161 TSR (DigiCert) |
| `globalsign.tsr` | RFC 3161 TSR (GlobalSign) |
| `alfasign.tsr` | RFC 3161 TSR (Alfasign, eIDAS QTSP) |
| `eth-anchor.json` | Ethereum L2 tx hash, block, chain ID, RPC URL, manifest SHA-256 |
| `qsig.asice` | ASiCE container signed with eID |

### 13.3 Timestamping

Parallel RFC 3161 queries per commit:

| TSA | Endpoint | Auth |
|-----|----------|------|
| Sectigo | `http://timestamp.sectigo.com/qualified` | None |
| DigiCert | `http://timestamp.digicert.com` | None |
| GlobalSign | `http://timestamp.globalsign.com/tsa/r6advanced1` | None |
| Alfasign | `https://tsa.alfasign.ro/TSAServer/get.aspx` | HTTP Basic via `pass` |

Alfasign creds in `pass` (`ALFASIGN_PASS_USER`, `ALFASIGN_PASS_KEY`). OTS (`ots stamp`) provides Bitcoin anchoring; `.ots` created immediately, confirmation async.

### 13.4 Blockchain Anchoring

Ethereum L2 via `cast send` (Foundry). Manifest SHA-256 as calldata, zero-value tx to sender's own address. Key/addr in `pass` (`ETH_PASS_KEY`, `ETH_PASS_ADDR`). RPC/chain in config (`ETH_RPC_URL`, `ETH_CHAIN_ID`).

### 13.5 Electronic Signature

Every package shall be signed with eID. Default: PKCS#11 via card (`digidoc-tool sign --pkcs11`). Fallback: Smart-ID (`qdigidoc4`) if no card is detected. The ASiCE container shall contain the manifest and Sectigo TSR.

### 13.6 Chain Commits

`qsig` stages `.chain/{short}/`, commits `qsig: {short}` with `--no-verify`. Lock file `${GIT_DIR}/.qsig-lock` prevents recursion: hook exits if present; qsig creates before commit, removes after.

### 13.7 GitHub Enforcement

`.mainproj` repos include `qsig-verify.yml` at `.github/workflows/`. Required status check on `main`/`staging`. Verifies per non-chain commit: `.chain/{short}/` exists, `manifest.txt` hash matches, at least one `.tsr`, `eth-anchor.json`, `qsig.asice`. Commits prefixed `qsig:` excluded. Failures reject push/PR.

### 13.8 Infrastructure

| File | Purpose |
|------|---------|
| `~/git/dangstd/bin/qsig` | Orchestrator |
| `~/git/dangstd/config/qsig/config` | Config (pass paths, RPC, chain ID, PKCS#11) |
| `~/git/dangstd/hooks/post-commit` | Invokes qsig after branchless hook |
| `~/git/dangstd/workflows/qsig-verify.yml` | GitHub Actions workflow |

Symlinks: `~/bin/qsig` -> dangstd; `~/.config/qsig` -> dangstd.

### 13.9 Credentials

All in `pass`: `qsig/alfasign/user`, `qsig/alfasign/passwd`, `qsig/bchain/eth/addr`, `qsig/bchain/eth/secret`. Paths configurable via config.

### 13.10 Verification

OTS: `ots verify .chain/{short}/manifest.txt.ots`
RFC 3161: `openssl ts -verify -in {tsa}.tsr -data manifest.txt -CAfile <ca-cert>`
eID: `digidoc-tool open .chain/{short}/qsig.asice`
Manifest: `git show {commit}:{file} | sha256sum` vs manifest entry
Ethereum: verify tx on block explorer via `eth-anchor.json`

### 13.11 Retention

`.chain/` shall not be removed from repo or history. Files shall not be modified after creation.

---

## 14. Post-Quantum Tunnel

### 14.1 Applicability

All SSH connections shall use PQ-authenticated tunnel wrapping. Naked SSH shall not be used. This requirement applies regardless of SSH PQ KEX, as SSH lacks PQ signature keys. This provision shall be revised when OpenSSH adds ML-DSA/SLH-DSA; the tunnel may be retained for defense-in-depth.

### 14.2 Architecture

```
SSH (PQ KEX) --> Kryphos (ML-DSA + ML-KEM + ChaCha20-Poly1305) --> TLS 1.3 (ML-DSA mTLS) --> Network
```

Phase 1: outer TLS 1.3. Phase 2: Kryphos middle layer. Both use ML-DSA-87. SSH negotiates PQ KEX (`sntrup761x25519-sha512@openssh.com`, `mlkem768x25519-sha256`), targets `127.0.0.1`. Server `sshd` binds `127.0.0.1` only; port 22 not exposed.

### 14.3 Cryptographic Parameters

| Layer | Function | Algorithm |
|-------|----------|-----------|
| TLS auth | Signature | ML-DSA-87 (FIPS 204) |
| TLS KEX | KEM | X25519MLKEM768 |
| TLS symmetric | AEAD | ChaCha20-Poly1305 |
| Kryphos auth | Signature | ML-DSA (Dilithium-5) |
| Kryphos KEX | KEM | ML-KEM (Kyber-1024) |
| Kryphos symmetric | AEAD | ChaCha20-Poly1305 |

NIST P-curves shall not be used. SHA-2 shall not be used (except TLS 1.3 PRF, which is exempt). SLH-DSA-SHAKE-256s is available as fallback.

### 14.4 Certificate Chain

Self-signed ML-DSA-87 CA issues server and client certs (ML-DSA-87).

Subject DN: `O=Ongakken Corporation OU, serialNumber=17168301, L=Tallinn, ST=Harju maakond, C=EE, street=Kalaranna tn 8/2-30, 10415`

| Cert | CN | Validity | Key Usage |
|------|----|----------|-----------|
| CA | `Ongakken Corporation OU PQ Tunnel CA` | 3650d | Cert Sign, CRL Sign |
| Server | `{fqdn}` | 365d | Digital Sig, Key Encipher |
| Client | `{full_name}` (+emailAddress) | 365d | Digital Sig, Key Encipher |

Keys/certs in `pass`: `pqtun/ca/key|cert`, `pqtun/server/{host}/key|cert`, `pqtun/client/{host}/key|cert`. Scripts extract from `pass` at runtime. Deploy: `pqtun deploy {hostname}` -> `/etc/pqtun/`.

### 14.5 TLS Tunnel

`stunnel` or equivalent (OpenSSL 3.6+).

**Server:** listen 2222 (`PQTUN_PORT`), forward `127.0.0.1:22`, TLSv1.3 only, mTLS (verify=2), certs at `/etc/pqtun/`.
**Client:** listen `127.0.0.1:{local_port}`, connect `{server}:2222`, TLSv1.3 only, verify=2, certs at `~/.config/pqtun/`.
**SSH:** `HostName 127.0.0.1, Port {local_port}, ProxyCommand none`.

### 14.6 Server Lockdown

After the tunnel is verified: `sshd ListenAddress 127.0.0.1`, firewall shall block port 22. Only PQTUN_PORT shall be externally accessible. Lockdown shall not proceed until the tunnel is verified.

### 14.7 Infrastructure

`~/git/dangstd/bin/pqtun` (manage), `~/git/dangstd/bin/pqtun-certgen` (certs), `~/git/dangstd/config/pqtun/` (config + templates).
Symlinks: `~/bin/pqtun|pqtun-certgen` -> dangstd; `~/.config/pqtun` -> dangstd.

### 14.8 Credentials

All in `pass` (§14.4). Deploy extracts to `/etc/pqtun/` (keys 0600, certs 0644). Client startup extracts to tmpdir, erases on shutdown.

### 14.9 Renewal

Server and client certificates shall be renewed before expiry: `pqtun-certgen renew`. All certificates shall be reissued on CA renewal. Expiration shall be monitored via cron/timers.

### 14.10 Verification

`pqtun status {host}` = TLS + cert + SSH check. `openssl verify -CAfile ca.pem server.pem` = chain. `openssl x509 -in server.pem -text -noout` = confirm ML-DSA-87.

---

## 15. EMIRU Binary Format

32-byte header executable binary format for loading user-space processes. All multi-byte fields shall be little-endian.

### 15.1 Header Layout

| Offset | Size | Field | Type | Constraints |
|--------|------|-------|------|-------------|
| 0 | 6 | `magic` | `byte[6]` | Shall be `"EMIRU\0"` (null-terminated) |
| 6 | 1 | `rev` | `byte` | Shall be 1 |
| 7 | 1 | `ring` | `byte` | Shall be 0, 1, 2, or 3 |
| 8 | 1 | `flags` | `byte` | Bit 0: PIC (position-independent code); bits 1-7 reserved |
| 9 | 1 | `reserved0` | `byte` | Shall be zero on encode; shall be ignored on decode |
| 10 | 2 | `prog_rev` | `word` | Application-defined program revision |
| 12 | 4 | `entry` | `dword` | Offset relative to text section start; shall be less than `text_size` |
| 16 | 4 | `text_size` | `dword` | Text section size in bytes; shall be greater than 0 |
| 20 | 4 | `data_size` | `dword` | Data section size in bytes; may be 0 |
| 24 | 4 | `bss_size` | `dword` | BSS declared size in bytes; not present in binary |
| 28 | 4 | `reserved1` | `dword` | Shall be zero on encode; shall be ignored on decode |

### 15.2 Section Layout

```
[header 32B][text (text_size bytes)][data (data_size bytes)]
```

The binary shall contain at least `32 + text_size + data_size` bytes. BSS is declared size only; the loader shall zero-initialize `bss_size` bytes immediately following the data section in memory. No arbitrary maximum size is imposed; the buffer length parameter constrains.

### 15.3 Validation

If `magic` does not match, the behavior is undefined. If `rev` is not 1, the binary shall be rejected. If `ring` exceeds 3, the binary shall be rejected. If `text_size` is 0, or `entry` is not less than `text_size`, the entry point is invalid and the binary shall be rejected. If `text_size + data_size` overflows, or the buffer is shorter than the required minimum, the binary is truncated and shall be rejected.

---

## 16. EMIEMI Transfer Protocol

Serial binary transfer protocol for sending payloads over byte-oriented transports. The protocol has no version field, no compression, and no encryption.

### 16.1 Frame Layout

```
<<EMIEMI>XXXXXX>[payload bytes]<<EMIEMI>>
```

| Component | Size | Constraints |
|-----------|------|-------------|
| Start marker | 9 bytes | Shall be ASCII `<<EMIEMI>` |
| Size field | 6 bytes | Shall be 6 uppercase hexadecimal ASCII digits (`0-9`, `A-F`); big-endian digit order |
| Delimiter | 1 byte | Shall be ASCII `>` (0x3E) |
| Payload | variable | Raw bytes; length as declared by size field |
| End marker | 10 bytes | Shall be ASCII `<<EMIEMI>>` |

Total overhead: 26 bytes.

### 16.2 Size Field

The size field shall consist of exactly 6 uppercase hexadecimal ASCII digits. Lowercase hexadecimal digits shall not be accepted. The maximum payload size shall be 16,777,215 bytes (0xFFFFFF). If the size field contains characters outside `0-9` or `A-F`, the frame shall be rejected.

### 16.3 Integrity

FNV-1a (32-bit) shall be computed independently by sender and receiver over the payload bytes. The offset basis shall be 2,166,136,261; the prime shall be 16,777,619. The hash is not included in the wire format; the caller shall compare sender and receiver hashes to detect corruption.

### 16.4 Marker Collision

The payload may contain byte sequences identical to the start or end markers. The size field disambiguates payload boundaries; the end marker position is deterministic from the declared payload size.

---

## Appendix A: Document History

| Ver | Date | Changes |
|-----|------|---------|
| 1.0 | 2026-01-23 | Initial |
| 1.1 | 2026-01-24 | Test state tracking; `.test-state` gitignore |
| 1.2 | 2026-01-27 | QEMU/KVM enforcement; dangstd symlinks |
| 1.3 | 2026-01-27 | §5.10 rewrite: persistent VMs, SSH runner, 9p, cloud-init |
| 1.4 | 2026-01-29 | `std.cmake`: C99, POSIX, pedantic, SYSTEM includes |
| 1.5 | 2026-01-30 | ISO/IEC conformance language; expanded error codes |
| 1.6 | 2026-01-30 | Restructured: §3 Terms; §4 libdangling before Code Style |
| 1.7 | 2026-02-07 | §3 priority levels: BLUE/ULTRAVIOLET/PRIORITY taxonomy |
| 1.8 | 2026-02-07 | §13 Qualified Signatures |
| 1.9 | 2026-02-07 | §14 Post-Quantum Tunnel |
| 2.0 | 2026-02-08 | §4.12 Protocol module; §15 EMIRU Binary Format; §16 EMIEMI Transfer Protocol; §4.2 error code range update |
